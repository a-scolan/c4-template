/**
 * Dev-Forge System Model
 * 
 * Defines the architecture of the Dev-Forge development platform:
 * - C1: System Context (actors, external systems)
 * - C2: Containers (Forgejo, Puppet, databases, runners)
 * - C3: Components (plugins, modules within containers)
 * 
 * Technology: Forgejo (Git platform) + Puppet (infrastructure automation)
 * Deployment: On-premises, staging-first approach
 */

model {
  
  // ============================================================================
  // C1: SYSTEM CONTEXT
  // ============================================================================
  
  /**
   * ACTORS
   * Human and system actors interacting with Dev-Forge
   */
  
  developer = Actor_Person 'Developer' {
    description 'Software developers using Dev-Forge for code hosting, CI/CD, and collaboration'
  }
  
  admin = Actor_Admin 'Platform Administrator' {
    description 'Infrastructure team managing Dev-Forge platform operations and configuration'
  }
  
  ciSystem = Actor 'CI/CD System' {
    description 'Automated CI/CD pipelines triggered by code changes'
    technology 'Forgejo Actions'
  }
  
  /**
   * SYSTEMS
   * Dev-Forge and external systems it integrates with
   */
  
  devforge = System_New 'Dev-Forge Platform' {
    description '''
      On-premises development platform providing Git hosting, CI/CD automation,
      code review, and package management. Technology-agnostic, supports any
      programming language or framework.
    '''
    
    // ------------------------------------------------------------------------
    // C2: CONTAINERS
    // Forgejo Application Tier
    // ------------------------------------------------------------------------
    
    forgejoWeb = Container_Webapp 'Forgejo Web Application' {
      #Internal
      description '''
        Main web interface for Git repository management, code browsing, and
        configuration. Provides UI for developers and administrators.
      '''
      technology 'Go'
      
      // C3: Components (MVP Plugins) within Forgejo Web
      authModule = Component 'Authentication Module' {
        description '''
          Handles user authentication via LDAP/OIDC. Integrates with corporate
          identity providers for single sign-on. Maps groups to admin privileges.
        '''
        technology 'LDAP client, OIDC client'
      }
      
      repoModule = Component 'Repository Management' {
        description '''
          Core Git repository operations. Branch protection, access control,
          file browsing, commit history, and repository settings.
        '''
        technology 'Git, Go'
      }
      
      actionsModule = Component 'Actions UI Module' {
        description '''
          User interface for CI/CD workflows. View workflow runs, logs, artifacts,
          and runner status. Configure workflow triggers and secrets.
        '''
        technology 'Go templates, JavaScript'
      }
      
      registryBridge = Component 'Registry Bridge' {
        description '''
          Package registry integration layer. Proxies requests to Nexus after
          authenticating with Forgejo credentials. Supports npm, Maven, Docker, PyPI.
        '''
        technology 'HTTP proxy, token exchange'
      }
      
      codeReviewModule = Component 'Code Review Module' {
        description '''
          Merge request (pull request) workflow. Inline comments, approval tracking,
          status checks integration, and auto-merge capability.
        '''
        technology 'Go, websockets'
      }
      
      pagesModule = Component 'Pages Module' {
        description '''
          Static website hosting from repository branches (Forgejo Pages). Automatic
          deployment on push, custom domain support, HTTPS. Similar to GitHub Pages.
        '''
        technology 'Static file serving, HTTPS'
      }
    }  // end forgejoWeb
    
    gitBackend = Container_Api 'Git Backend API' {
      #Internal
      description '''
        Git protocol handler (HTTP/HTTPS and SSH). Manages repository cloning,
        pushing, pulling, and access control enforcement.
      '''
      technology 'Go'
    }
    
    actionsScheduler = Container_ApplicationServer 'Actions Scheduler' {
      #Internal #Pipeline
      description '''
        CI/CD workflow scheduler and orchestrator. Monitors repository changes,
        queues workflows, assigns to available runners, and tracks execution status.
      '''
      technology 'Go'
    }
    
    runnerPool = Container_ProcessingServer 'Runner Pool Manager' {
      #Internal #DeploymentAutomation
      description '''
        Manages containerized Forgejo Actions runners. Handles registration,
        health monitoring, queue-based auto-scaling (3-5 base, up to 10 max).
      '''
      technology 'Docker'
    }
    
    postgresDb = Container_Database 'PostgreSQL Database' {
      #DataTier #Persistence
      description '''
        Primary data store for Forgejo. Stores users, repositories metadata,
        issues, merge requests, CI/CD workflow state, and configuration.
      '''
      technology 'PostgreSQL 14+'
    }
    
    // ------------------------------------------------------------------------
    // C2: CONTAINERS
    // Puppet Infrastructure Automation
    // ------------------------------------------------------------------------
    
    puppetMaster = Container_ApplicationServer 'Puppet Master' {
      #Internal #DeploymentAutomation
      description '''
        Central Puppet server managing infrastructure configuration. Compiles
        catalogues, distributes manifests, and orchestrates deployments across
        Dev-Forge infrastructure.
      '''
      technology 'Puppet Server'
    }
    
    puppetAgents = Container_ProcessingServer 'Puppet Agents' {
      #DeploymentAutomation
      description '''
        Puppet agents running on Dev-Forge VMs (Forgejo servers, runners, database).
        Apply configurations, manage services, and report state to Puppet Master.
      '''
      technology 'Puppet Agent, Ruby'
    }
  }
  
  /**
   * EXTERNAL SYSTEMS
   * Systems Dev-Forge integrates with
   */
  
  nexus = System_Existing 'Nexus Repository Manager' {
    #External
    description '''
      Existing organizational package repository manager. Provides npm, Maven,
      Docker, PyPI registries. Proxies to public package repositories.
      Dev-Forge integrates via proxy/bridge pattern.
    '''
    technology 'Nexus Repository Manager 3'
  }
  
  ldapServer = System_Existing 'LDAP/Active Directory' {
    #External #Security
    description '''
      Corporate directory service providing user authentication and group membership.
      Forgejo integrates for SSO and authorization.
    '''
    technology 'OpenLDAP or Active Directory'
  }
  
  puppetForge = System_External 'Puppet Forge' {
    #External
    description '''
      Public Puppet module repository. Source for community Puppet modules
      used in Dev-Forge infrastructure automation.
    '''
    technology 'Puppet Forge (public)'
  }
  
  publicRepos = System_External 'Public Package Repositories' {
    #External
    description '''
      Upstream package repositories (npmjs.org, Maven Central, Docker Hub, pypi.org).
      Proxied via Nexus for caching and availability.
    '''
    technology 'Public internet services'
  }
  
  // ============================================================================
  // RELATIONSHIPS (C1: System Context Level)
  // ============================================================================
  
  // Developer interactions
  developer -> devforge.forgejoWeb {
    uses 'Manages repositories, reviews code, monitors CI/CD'
    technology 'HTTPS (web browser)'
  }
  
  developer -> devforge.gitBackend {
    calls 'Clones, pushes, pulls Git repositories'
    technology 'Git over HTTPS/SSH'
  }
  
  // Administrator workflows
  admin -> devforge.forgejoWeb {
    uses 'Configures platform, manages users, monitors runners'
    technology 'HTTPS (web browser)'
  }
  
  admin -> devforge.puppetMaster {
    uses 'Deploys infrastructure, applies configuration changes'
    technology 'Puppet CLI'
  }
  
  // CI/CD system automation
  ciSystem -> devforge.actionsScheduler {
    async 'Triggers workflows on push, pull request events'
  }
  
  // ============================================================================
  // RELATIONSHIPS (C2: Container Level)
  // ============================================================================
  
  // Web application dependencies
  devforge.forgejoWeb -> devforge.postgresDb {
    reads 'Queries user accounts, repository metadata, workflow state'
    technology 'PostgreSQL wire protocol'
  }
  
  devforge.forgejoWeb -> devforge.gitBackend {
    calls 'Delegates Git operations (file browsing, diffs)'
  }
  
  devforge.forgejoWeb -> devforge.actionsScheduler {
    calls 'Triggers workflows, queries execution status'
  }
  
  // Git backend
  devforge.gitBackend -> devforge.postgresDb {
    reads 'Validates access control and permissions'
  }
  
  // Actions CI/CD
  devforge.actionsScheduler -> devforge.runnerPool {
    async 'Assigns workflows to available runners'
  }
  
  devforge.actionsScheduler -> devforge.postgresDb {
    writes 'Persists workflow runs, logs, and status'
  }
  
  devforge.runnerPool -> devforge.actionsScheduler {
    calls 'Reports runner health, requests workflow jobs'
  }
  
  // External integrations (container level)
  devforge.forgejoWeb -> ldapServer {
    calls 'Authenticates users, retrieves group membership'
    technology 'LDAP protocol'
  }
  
  devforge.forgejoWeb -> nexus {
    calls 'Proxies package requests (token exchange)'
    technology 'Nexus REST API'
  }
  
  devforge.runnerPool -> publicRepos {
    reads 'Downloads dependencies during workflow execution'
    technology 'HTTPS'
  }
  
  // Nexus upstream
  nexus -> publicRepos {
    reads 'Proxies and caches public packages'
    technology 'HTTPS'
  }
  
  // Puppet orchestration
  devforge.puppetMaster -> devforge.puppetAgents {
    calls 'Distributes configuration catalogues'
    technology 'Puppet protocol (HTTPS)'
  }
  
  devforge.puppetAgents -> devforge.forgejoWeb {
    uses 'Deploys and configures Forgejo application'
  }
  
  devforge.puppetAgents -> devforge.runnerPool {
    uses 'Provisions and scales runner VMs'
  }
  
  devforge.puppetAgents -> devforge.postgresDb {
    uses 'Provisions database, manages backups'
  }
  
  devforge.puppetMaster -> puppetForge {
    reads 'Downloads community Puppet modules'
    technology 'HTTPS'
  }
  
  // ============================================================================
  // RELATIONSHIPS (C3: Component Level - within forgejoWeb)
  // ============================================================================
  
  devforge.forgejoWeb.authModule -> devforge.postgresDb {
    writes 'Creates user accounts, updates profiles'
  }
  
  devforge.forgejoWeb.authModule -> ldapServer {
    calls 'Validates credentials, retrieves user attributes'
  }
  
  devforge.forgejoWeb.repoModule -> devforge.gitBackend {
    calls 'Executes Git commands (clone, commit, diff)'
  }
  
  devforge.forgejoWeb.repoModule -> devforge.postgresDb {
    writes 'Stores repository metadata, access permissions'
  }
  
  devforge.forgejoWeb.actionsModule -> devforge.actionsScheduler {
    calls 'Queries workflow status, retrieves logs'
  }
  
  devforge.forgejoWeb.actionsModule -> devforge.runnerPool {
    reads 'Monitors runner availability and health'
  }
  
  devforge.forgejoWeb.registryBridge -> nexus {
    calls 'Proxies package install/publish requests'
    technology 'Nexus user token API'
  }
  
  devforge.forgejoWeb.registryBridge -> devforge.postgresDb {
    reads 'Validates user permissions for package access'
  }
  
  devforge.forgejoWeb.codeReviewModule -> devforge.postgresDb {
    writes 'Stores merge requests, comments, approvals'
  }
  
  devforge.forgejoWeb.codeReviewModule -> devforge.actionsModule {
    calls 'Checks CI/CD status before allowing merge'
  }
}
