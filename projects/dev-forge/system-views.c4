/**
 * Dev-Forge System Views
 * 
 * Visualization of the Dev-Forge platform architecture at multiple C4 levels:
 * - C1: System Context (external actors and systems)
 * - C2: Container Views (internal architecture)
 * - C3: Component Views (MVP plugins detail)
 * - Use Cases: Dynamic workflows
 */

views {
  
  // ==========================================================================
  // C1: SYSTEM CONTEXT
  // ==========================================================================
  
  /**
   * C1: System Context View
   * Shows Dev-Forge platform in its environment with actors and external systems
   * 
   * Audience: Stakeholders, architects, management
   * Purpose: Understand what Dev-Forge is, who uses it, and what it integrates with
   */
  view c1_context {
    title 'C1 / System Context - Dev-Forge Platform'
    
    description """
      Dev-Forge development platform ecosystem showing human and system actors,
      the main Dev-Forge system, and external integrations (LDAP, Nexus, public repos).
      
      **Key Interactions:**
      - Developers use Git and web UI for code management
      - Administrators configure platform via UI and Puppet
      - CI/CD systems trigger automated workflows
      - External systems provide authentication and package management
    """
    
    // Include all actors and systems
    include developer
    include admin
    include ciSystem
    include devforge
    include nexus
    include ldapServer
    include puppetForge
    include publicRepos
    
    // Layout guidance: actors at top
    rank source { developer, admin, ciSystem }
    rank sink { nexus, ldapServer, puppetForge, publicRepos }
  }
  
  // ==========================================================================
  // C2: CONTAINER VIEWS
  // ==========================================================================
  
  /**
   * C2: Forgejo Platform Containers
   * Details internal architecture of Forgejo application and infrastructure components
   * 
   * Audience: Architects, senior developers, operations team
   * Purpose: Understand major runtime components and their interactions
   */
  view c2_forgejo_containers {
    title 'C2 / Forgejo Platform Containers'
    
    description """
      Internal architecture of Dev-Forge showing Forgejo containers,
      Puppet infrastructure automation, and data storage.
      
      **Container Types:**
      - **Web/API Tier**: User interface and Git protocol handlers
      - **CI/CD Tier**: Actions scheduler and runner pool
      - **Automation Tier**: Puppet master and agents
      - **Data Tier**: PostgreSQL database
      
      **Scalability**: Runner pool auto-scales 3-5 base, up to 10 max
    """
    
    include developer
    include admin
    include ciSystem
    include devforge.*  // All containers within devforge
    include nexus
    include ldapServer
    include puppetForge
    
    // Layout: separate tiers
    rank source { developer, admin, ciSystem }
    
    rank same { devforge.forgejoWeb, devforge.gitBackend }
    
    rank same { devforge.actionsScheduler, devforge.runnerPool }
    
    rank sink { devforge.postgresDb, nexus, ldapServer }
  }
  
  /**
   * C2: CI/CD Focus View
   * Dedicated view for Forgejo Actions CI/CD architecture
   * 
   * Audience: DevOps engineers, platform administrators
   * Purpose: Understand CI/CD workflow scheduling and runner management
   */
  view c2_cicd_focus {
    title 'C2 / CI/CD Architecture - Forgejo Actions'
    
    description """
      Focused view of Forgejo Actions CI/CD components showing workflow
      scheduling, runner pool management, and auto-scaling capabilities.
      
      **Flow:**
      1. Developer commits trigger actionsScheduler
      2. Scheduler assigns workflows to runnerPool
      3. Runner pool scales based on queue depth
      4. Results persisted to PostgreSQL
      5. Runners fetch dependencies from Nexus/public repos
      
      **Scaling Strategy**: Queue-based auto-scaling with health monitoring
    """
    
    include developer -> devforge.gitBackend
    include ciSystem
    include devforge.actionsScheduler
    include devforge.runnerPool
    include devforge.postgresDb
    include nexus
    include publicRepos
    
    // CI/CD flow layout
    rank source { developer, ciSystem }
    rank same { devforge.actionsScheduler, devforge.runnerPool }
    rank sink { devforge.postgresDb, nexus, publicRepos }
    
    style devforge.actionsScheduler {
      color secondary
    }
    
    style devforge.runnerPool {
      color secondary
    }
  }
  
  /**
   * C2: Infrastructure Automation View
   * Shows Puppet configuration management for Dev-Forge infrastructure
   * 
   * Audience: Infrastructure team, platform administrators
   * Purpose: Understand automated provisioning and configuration workflows
   */
  view c2_puppet_automation {
    title 'C2 / Infrastructure Automation - Puppet'
    
    description """
      Puppet-based infrastructure automation showing configuration
      distribution from Puppet Master to agents running on Dev-Forge VMs.
      
      **Managed Components:**
      - Forgejo application deployment
      - Runner VM provisioning and scaling
      - PostgreSQL database configuration
      - Backup and monitoring setup
      
      **Module Sources**: Internal manifests + Puppet Forge community modules
    """
    
    include admin
    include devforge.puppetMaster
    include devforge.puppetAgents
    include puppetForge
    include devforge.forgejoWeb
    include devforge.runnerPool
    include devforge.postgresDb
    
    // Automation flow
    rank source { admin }
    rank same { devforge.puppetMaster, puppetForge }
    rank same { devforge.puppetAgents }
    rank sink { devforge.forgejoWeb, devforge.runnerPool, devforge.postgresDb }
    
    style devforge.puppetMaster {
      color muted
    }
    
    style devforge.puppetAgents {
      color muted
    }
  }
  
  // ==========================================================================
  // C3: COMPONENT VIEWS (MVP Plugins)
  // ==========================================================================
  
  /**
   * C3: Forgejo UI Components (MVP Plugins)
   * Shows modular plugin architecture within Forgejo web application
   * 
   * Audience: Developers, technical architects
   * Purpose: Understand internal modules and their responsibilities
   */
  view c3_mvp_plugins {
    title 'C3 / MVP Plugins - Forgejo Modules'
    
    description """
      Component-level view of Forgejo web application showing MVP plugins:
      
      **MVPPlugins (5 critical features):**
      1. **Authentication**: LDAP/OIDC integration for SSO
      2. **Repository Management**: Core Git operations and access control
      3. **Actions UI**: CI/CD workflow monitoring and configuration
      4. **Registry Bridge**: Nexus package registry integration
      5. **Code Review**: Merge request/pull request workflows
      
      **Modularity**: Each plugin can be configured/disabled independently
    """
    
    include developer
    include devforge.forgejoWeb.*  // All components within forgejoWeb
    include devforge.gitBackend
    include devforge.actionsScheduler
    include devforge.runnerPool
    include devforge.postgresDb
    include ldapServer
    include nexus
    
    // Module organization
    rank source { developer }
    
    rank same { devforge.forgejoWeb.authModule, devforge.forgejoWeb.repoModule, devforge.forgejoWeb.actionsModule }
    
    rank same { devforge.forgejoWeb.registryBridge, devforge.forgejoWeb.codeReviewModule }
    
    rank sink { devforge.postgresDb, ldapServer, nexus }
    
    // Highlight critical plugins
    style devforge.forgejoWeb.authModule {
      color red
    }
    
    style devforge.forgejoWeb.actionsModule {
      color secondary
    }
  }
  
  /**
   * C3: Authentication & Authorization Flow
   * Detailed view of authentication module integration
   * 
   * Audience: Security architects, identity management team
   * Purpose: Understand SSO integration and user provisioning
   */
  view c3_auth_flow {
    title 'C3 / Authentication Flow - LDAP/OIDC Integration'
    
    description """
      Authentication module details showing LDAP/OIDC integration for
      corporate single sign-on and group-based authorization.
      
      **Supported Protocols:**
      - LDAP: Direct directory queries for user/group lookup
      - OIDC: OAuth 2.0 / OpenID Connect for federated identity
      
      **Flow:**
      1. User attempts login via Forgejo UI
      2. authModule queries LDAP/OIDC provider
      3. Provider returns user attributes and group membership
      4. authModule creates/updates local user account in PostgreSQL
      5. Groups mapped to admin privileges
    """
    
    include developer
    include devforge.forgejoWeb.authModule
    include devforge.postgresDb
    include ldapServer
    
    rank source { developer }
    rank sink { devforge.postgresDb, ldapServer }
    
    style devforge.forgejoWeb.authModule {
      color red
    }
  }
  
  /**
   * C3: Package Registry Integration
   * Shows Nexus integration via registry bridge component
   * 
   * Audience: Developers, DevOps engineers
   * Purpose: Understand package management integration
   */
  view c3_registry_integration {
    title 'C3 / Package Registry - Nexus Integration'
    
    description """
      Registry bridge component proxying package requests to Nexus
      while maintaining Forgejo authentication context.
      
      **Supported Registries:**
      - npm (Node.js packages)
      - Maven (Java dependencies)
      - Docker (container images)
      - PyPI (Python packages)
      
      **Flow:**
      1. Developer authenticates to Forgejo
      2. Package install/publish request to registryBridge
      3. Bridge exchanges Forgejo token for Nexus token
      4. Request proxied to Nexus with correct credentials
      5. Nexus fetches from public repos if needed (caching)
    """
    
    include developer
    include devforge.forgejoWeb.registryBridge
    include devforge.postgresDb
    include nexus
    include publicRepos
    
    rank source { developer }
    rank same { devforge.postgresDb, nexus }
    rank sink { publicRepos }
    
    style devforge.forgejoWeb.registryBridge {
      color amber
    }
  }
  
  // ==========================================================================
  // USE CASES: DYNAMIC WORKFLOWS
  // ==========================================================================
  
  /**
   * Developer Onboarding Flow
   * Shows step-by-step workflow for new developer first day
   */
  dynamic view usecase_developer_onboarding {
    title 'Use Cases / Developer Onboarding'
      
      description """
        New developer's first day workflow from account creation to first commit.
        
        **Prerequisites:**
        - LDAP/OIDC account provisioned by IT
        - Developer documentation access
        
        **Outcome:**
        - Repository created
        - SSH keys configured
        - First commit pushed successfully
      """
      
      developer -> devforge.forgejoWeb 'Access Forgejo web UI (HTTPS)'
      devforge.forgejoWeb -> devforge.forgejoWeb.authModule 'Redirect to login'
      devforge.forgejoWeb.authModule -> ldapServer 'Validate credentials (LDAP/OIDC)'
      ldapServer -> devforge.forgejoWeb.authModule 'Return user attributes, groups'
      devforge.forgejoWeb.authModule -> devforge.postgresDb 'Create user account'
      devforge.postgresDb -> devforge.forgejoWeb.authModule 'User ID, session token'
      devforge.forgejoWeb.authModule -> devforge.forgejoWeb 'Session established'
      devforge.forgejoWeb -> developer 'Display dashboard'
      
      developer -> devforge.forgejoWeb.repoModule 'Create new repository'
      devforge.forgejoWeb.repoModule -> devforge.gitBackend 'Initialize Git repo'
      devforge.forgejoWeb.repoModule -> devforge.postgresDb 'Store repo metadata'
      devforge.forgejoWeb.repoModule -> developer 'Repository created, show clone URL'
      
      developer -> devforge.gitBackend 'git clone (SSH/HTTPS)'
      devforge.gitBackend -> devforge.postgresDb 'Verify permissions'
      devforge.gitBackend -> developer 'Transfer repository data'
      
      developer -> devforge.gitBackend 'git push (first commit)'
      devforge.gitBackend -> devforge.postgresDb 'Update commit history'
      devforge.gitBackend -> developer 'Push successful'
    }
    
    /**
     * CI/CD Workflow Trigger and Execution
     * Shows automated workflow from commit to completion
     */
    dynamic view usecase_cicd_workflow {
      title 'Use Cases / CI/CD Workflow Execution'
      
      description """
        Automated CI/CD workflow triggered by code push, showing Forgejo Actions
        job scheduling, runner assignment, and result reporting.
        
        **Trigger:** Developer pushes commit with .forgejo/workflows/*.yml
        **Steps:** Build → Test → Package → Deploy (staging)
        **Duration:** ~5-10 minutes typical workflow
      """
      
      developer -> devforge.gitBackend 'git push origin main'
      devforge.gitBackend -> devforge.actionsScheduler 'Webhook: push event'
      devforge.actionsScheduler -> devforge.postgresDb 'Create workflow run record'
      devforge.actionsScheduler -> devforge.runnerPool 'Assign job to available runner'
      
      devforge.runnerPool -> devforge.actionsScheduler 'Runner claims job'
      devforge.runnerPool -> devforge.gitBackend 'Checkout repository code'
      devforge.runnerPool -> nexus 'Fetch dependencies (npm install)'
      nexus -> publicRepos 'Cache miss: fetch from npmjs.org'
      publicRepos -> nexus 'Package data'
      nexus -> devforge.runnerPool 'Return cached packages'
      
      devforge.runnerPool -> devforge.runnerPool 'Execute workflow steps: build, test'
      devforge.runnerPool -> devforge.actionsScheduler 'Report progress, logs'
      devforge.actionsScheduler -> devforge.postgresDb 'Update workflow status'
      
      devforge.runnerPool -> devforge.actionsScheduler 'Workflow complete (success/failure)'
      devforge.actionsScheduler -> devforge.postgresDb 'Persist final status, artifacts'
      devforge.actionsScheduler -> developer 'Notification: workflow result'
    }
    
    /**
     * Code Review and Merge Flow
     * Shows collaborative code review via merge requests
     */
    dynamic view usecase_code_review {
      title 'Use Cases / Code Review & Merge Request'
      
      description """
        Developer submits code for review, collaborators provide feedback,
        CI/CD validates changes, and code is merged to main branch.
        
        **Actors:** Developer (author), Reviewer (approver), CI system
        **Protection:** Main branch requires approval + passing CI checks
      """
      
      developer -> devforge.gitBackend 'git push origin feature-branch'
      devforge.gitBackend -> devforge.postgresDb 'Store branch reference'
      
      developer -> devforge.forgejoWeb.codeReviewModule 'Create merge request (PR)'
      devforge.forgejoWeb.codeReviewModule -> devforge.postgresDb 'Create MR record'
      devforge.forgejoWeb.codeReviewModule -> devforge.forgejoWeb.actionsModule 'Check CI status'
      devforge.forgejoWeb.actionsModule -> devforge.actionsScheduler 'Query recent workflow runs'
      
      ciSystem -> devforge.actionsScheduler 'Run CI checks on feature-branch'
      devforge.actionsScheduler -> devforge.runnerPool 'Execute test suite'
      devforge.runnerPool -> devforge.actionsScheduler 'Tests passed ✓'
      devforge.actionsScheduler -> devforge.postgresDb 'Update CI status'
      
      admin -> devforge.forgejoWeb.codeReviewModule 'Review code, provide feedback'
      devforge.forgejoWeb.codeReviewModule -> devforge.postgresDb 'Store review comments'
      admin -> devforge.forgejoWeb.codeReviewModule 'Approve merge request ✓'
      devforge.forgejoWeb.codeReviewModule -> devforge.postgresDb 'Record approval'
      
      developer -> devforge.forgejoWeb.codeReviewModule 'Merge to main (auto-merge)'
      devforge.forgejoWeb.codeReviewModule -> devforge.forgejoWeb.actionsModule 'Verify: approval + CI pass'
      devforge.forgejoWeb.codeReviewModule -> devforge.gitBackend 'Perform merge operation'
      devforge.gitBackend -> devforge.postgresDb 'Update main branch reference'
      devforge.forgejoWeb.codeReviewModule -> developer 'Merge successful, delete feature-branch'
    }
    
    /**
     * Runner Auto-Scaling Behavior
     * Shows dynamic runner provisioning based on queue depth
     */
    dynamic view usecase_runner_scaling {
      title 'Use Cases / Runner Auto-Scaling'
      
      description """
        Automatic runner pool scaling in response to CI/CD workload.
        
        **Base Capacity:** 3-5 runners always running
        **Scale Trigger:** Queue depth > 10 pending jobs for 2+ minutes
        **Max Capacity:** 10 runners
        **Scale Down:** After 15 min idle time
        
        **Orchestration:** Puppet provisions new VMs, registers runners automatically
      """
      
      ciSystem -> devforge.actionsScheduler 'Multiple push events (high load)'
      devforge.actionsScheduler -> devforge.postgresDb 'Queue 15 workflow jobs'
      devforge.actionsScheduler -> devforge.runnerPool 'Assign jobs to 5 available runners'
      devforge.runnerPool -> devforge.actionsScheduler 'Queue depth: 10 pending, 5 running'
      
      devforge.actionsScheduler -> devforge.actionsScheduler 'Monitor: queue depth > threshold'
      devforge.actionsScheduler -> devforge.runnerPool 'Trigger scale-up: +3 runners needed'
      
      devforge.runnerPool -> devforge.puppetMaster 'Request runner VM provisioning'
      devforge.puppetMaster -> devforge.puppetAgents 'Apply runner manifest (3 new VMs)'
      devforge.puppetAgents -> devforge.runnerPool 'Provision VMs, install Docker, register runners'
      devforge.runnerPool -> devforge.actionsScheduler 'New runners available (total: 8)'
      
      devforge.actionsScheduler -> devforge.runnerPool 'Distribute pending jobs to new runners'
      devforge.runnerPool -> nexus 'Runners fetch dependencies in parallel'
      devforge.runnerPool -> devforge.actionsScheduler 'Jobs completing faster (higher throughput)'
      
      devforge.actionsScheduler -> devforge.postgresDb 'Queue cleared, all jobs complete'
      devforge.runnerPool -> devforge.runnerPool 'Monitor idle time: 15+ minutes'
      devforge.runnerPool -> devforge.puppetMaster 'Scale down: decommission 3 VMs'
      devforge.puppetMaster -> devforge.puppetAgents 'Remove runner VMs'
      devforge.runnerPool -> devforge.actionsScheduler 'Scaled to base capacity (5 runners)'
    }
  }
}
